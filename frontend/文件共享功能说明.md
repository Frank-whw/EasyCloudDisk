# EasyCloudDisk 文件共享功能说明

## 功能概述

EasyCloudDisk 现已支持完整的文件分享功能，用户可以将文件分享给其他人，支持密码保护、过期时间、下载次数限制等高级功能。

## 主要功能

### 1. 创建文件分享
- **位置**: 文件列表中每个文件的"分享"按钮
- **功能**: 
  - 设置分享名称和描述
  - 选择访问权限（只读、仅下载、读写）
  - 可选密码保护
  - 可选过期时间
  - 可选最大下载次数限制

### 2. 分享管理
- **位置**: 侧边栏"我的分享"
- **功能**:
  - 查看所有创建的分享
  - 复制分享链接
  - 查看分享状态和统计信息
  - 取消分享

### 3. 分享访问
- **访问方式**: 通过分享链接 `share.html?id=分享ID`
- **功能**:
  - 查看文件信息
  - 密码验证（如果设置了密码）
  - 下载文件
  - 显示分享者信息和限制

## 使用方法

### 创建分享

1. 在文件列表中找到要分享的文件
2. 点击文件的"分享"按钮
3. 填写分享信息：
   - **分享名称**: 显示给访问者的名称
   - **分享描述**: 分享的详细说明
   - **访问权限**: 
     - `只读`: 可以查看文件信息但不能下载
     - `仅下载`: 只能下载文件
     - `读写`: 完整访问权限
   - **访问密码**: 可选，设置后访问者需要输入密码
   - **过期时间**: 可选，分享的有效期
   - **最大下载次数**: 可选，限制下载次数
4. 点击"创建分享"
5. 复制生成的分享链接

### 管理分享

1. 点击侧边栏的"我的分享"
2. 查看所有分享列表，包括：
   - 分享状态（活跃/已过期/已达上限/已取消）
   - 下载统计
   - 分享链接
3. 可以复制分享链接或取消分享

### 访问分享

1. 打开分享链接
2. 如果设置了密码，输入密码验证
3. 查看文件信息
4. 点击"下载文件"按钮下载

## 技术实现

### 前端组件

- **shareManager.js**: 分享功能的核心逻辑
- **share.html**: 公共分享访问页面
- **相关CSS**: 分享界面的样式定义

### 后端API

- `POST /files/{fileId}/share`: 创建分享
- `GET /shares`: 获取用户分享列表
- `GET /files/{fileId}/share`: 获取文件分享信息
- `DELETE /shares/{shareId}`: 取消分享
- `GET /shares/{shareId}/info`: 获取分享信息（公开）
- `POST /shares/{shareId}/validate`: 验证分享密码（公开）
- `GET /shares/{shareId}/download`: 下载分享文件（公开）

### 数据库表

- **file_shares**: 存储分享信息
  - shareId: 分享唯一标识
  - fileId: 关联的文件ID
  - ownerId: 分享创建者
  - permission: 访问权限
  - password: 加密后的访问密码
  - expiresAt: 过期时间
  - maxDownloads: 最大下载次数
  - downloadCount: 当前下载次数
  - active: 分享状态

## 安全特性

1. **密码保护**: 支持为分享设置访问密码
2. **过期控制**: 支持设置分享过期时间
3. **下载限制**: 支持限制最大下载次数
4. **权限控制**: 细粒度的访问权限设置
5. **状态管理**: 自动清理过期和达到限制的分享

## 测试方法

### 使用测试页面

1. 启动后端服务器（端口8080）
2. 启动前端服务器：
   ```bash
   # Windows
   test-start.bat
   
   # 或手动启动
   python -m http.server 3000
   ```
3. 访问测试页面：`http://localhost:3000/test-share.html`
4. 按照页面提示进行功能测试

### 手动测试流程

1. **登录系统**: 使用有效的用户账号登录
2. **上传文件**: 先上传一个测试文件
3. **创建分享**: 为文件创建分享链接
4. **访问分享**: 在新的浏览器窗口中访问分享链接
5. **下载测试**: 验证下载功能是否正常
6. **管理测试**: 在"我的分享"中管理分享

## 注意事项

1. **CORS配置**: 确保后端正确配置了CORS，允许前端域名访问
2. **文件存储**: 分享的文件必须在S3或本地存储中存在
3. **权限验证**: 只有文件所有者可以创建和管理分享
4. **链接安全**: 分享链接包含随机生成的ID，具有一定的安全性
5. **清理机制**: 系统会自动清理过期的分享记录

## 故障排除

### 常见问题

1. **分享创建失败**
   - 检查用户是否有文件的所有权
   - 确认后端服务正常运行
   - 查看浏览器控制台错误信息

2. **分享访问失败**
   - 确认分享链接正确
   - 检查分享是否已过期或被取消
   - 验证密码是否正确

3. **下载失败**
   - 确认文件在存储中存在
   - 检查下载次数是否已达上限
   - 验证用户权限

### 调试方法

1. 打开浏览器开发者工具
2. 查看Network标签页的API请求
3. 检查Console标签页的错误信息
4. 使用测试页面进行功能验证

## 未来扩展

1. **批量分享**: 支持同时分享多个文件
2. **文件夹分享**: 支持分享整个文件夹
3. **分享统计**: 详细的访问和下载统计
4. **通知功能**: 分享访问时的邮件通知
5. **二维码**: 生成分享链接的二维码
