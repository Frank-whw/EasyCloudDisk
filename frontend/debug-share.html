<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«åŠŸèƒ½è°ƒè¯• - EasyCloudDisk</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ åˆ†äº«åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. ç¯å¢ƒæ£€æŸ¥</h2>
        <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        <div id="envResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>2. API å¯¹è±¡æ£€æŸ¥</h2>
        <button onclick="checkApiObject()">æ£€æŸ¥ API å¯¹è±¡</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>3. åˆ†äº«ç®¡ç†å™¨æ£€æŸ¥</h2>
        <button onclick="checkShareManager()">æ£€æŸ¥åˆ†äº«ç®¡ç†å™¨</button>
        <div id="shareManagerResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>4. æ‰‹åŠ¨æµ‹è¯•åˆ†äº«API</h2>
        <button onclick="testShareApi()">æµ‹è¯•åˆ†äº« API</button>
        <div id="shareApiResult" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>5. æ¨¡æ‹Ÿåˆ†äº«æ“ä½œ</h2>
        <button onclick="simulateShare()">æ¨¡æ‹Ÿåˆ›å»ºåˆ†äº«</button>
        <button onclick="simulateGetShares()">æ¨¡æ‹Ÿè·å–åˆ†äº«åˆ—è¡¨</button>
        <div id="simulateResult" class="result"></div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/shareManager.js"></script>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function checkEnvironment() {
            try {
                const info = {
                    'CONFIG å¯¹è±¡': typeof CONFIG !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
                    'API_BASE_URL': typeof CONFIG !== 'undefined' ? CONFIG.API_BASE_URL : 'æœªå®šä¹‰',
                    'utils å‡½æ•°': typeof showAlert !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½',
                    'æµè§ˆå™¨æ”¯æŒ': {
                        'fetch': typeof fetch !== 'undefined',
                        'Promise': typeof Promise !== 'undefined',
                        'localStorage': typeof localStorage !== 'undefined'
                    }
                };
                log('envResult', JSON.stringify(info, null, 2));
            } catch (error) {
                log('envResult', `ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`, true);
            }
        }

        function checkApiObject() {
            try {
                const info = {
                    'api å¯¹è±¡å­˜åœ¨': typeof api !== 'undefined',
                    'api ç±»å‹': typeof api,
                    'api æ„é€ å‡½æ•°': api ? api.constructor.name : 'N/A',
                    'baseURL': api ? api.baseURL : 'N/A',
                    'æ–¹æ³•åˆ—è¡¨': api ? Object.getOwnPropertyNames(Object.getPrototypeOf(api)).filter(name => typeof api[name] === 'function') : []
                };
                
                if (api) {
                    info['åˆ†äº«ç›¸å…³æ–¹æ³•'] = {
                        'createShare': typeof api.createShare,
                        'getUserShares': typeof api.getUserShares,
                        'getFileShare': typeof api.getFileShare,
                        'cancelShare': typeof api.cancelShare
                    };
                }
                
                log('apiResult', JSON.stringify(info, null, 2));
            } catch (error) {
                log('apiResult', `API å¯¹è±¡æ£€æŸ¥å¤±è´¥: ${error.message}`, true);
            }
        }

        function checkShareManager() {
            try {
                const info = {
                    'shareManager å¯¹è±¡å­˜åœ¨': typeof shareManager !== 'undefined',
                    'shareManager ç±»å‹': typeof shareManager,
                    'æ–¹æ³•åˆ—è¡¨': shareManager ? Object.getOwnPropertyNames(shareManager).filter(name => typeof shareManager[name] === 'function') : []
                };
                
                log('shareManagerResult', JSON.stringify(info, null, 2));
            } catch (error) {
                log('shareManagerResult', `åˆ†äº«ç®¡ç†å™¨æ£€æŸ¥å¤±è´¥: ${error.message}`, true);
            }
        }

        async function testShareApi() {
            try {
                log('shareApiResult', 'æ­£åœ¨æµ‹è¯• API è¿æ¥...');
                
                // æµ‹è¯•åŸºç¡€è¿æ¥
                const healthResponse = await fetch(`${CONFIG.API_BASE_URL}/health`);
                const healthData = await healthResponse.json();
                
                const result = {
                    'å¥åº·æ£€æŸ¥': healthResponse.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥',
                    'å“åº”çŠ¶æ€': healthResponse.status,
                    'å“åº”æ•°æ®': healthData
                };
                
                // æµ‹è¯•åˆ†äº« APIï¼ˆä¸éœ€è¦è®¤è¯çš„éƒ¨åˆ†ï¼‰
                try {
                    const shareResponse = await fetch(`${CONFIG.API_BASE_URL}/shares/test-id/info`);
                    result['åˆ†äº«APIæµ‹è¯•'] = shareResponse.status === 404 ? 'âœ… ç«¯ç‚¹å­˜åœ¨' : `çŠ¶æ€ç : ${shareResponse.status}`;
                } catch (shareError) {
                    result['åˆ†äº«APIæµ‹è¯•'] = `âŒ ${shareError.message}`;
                }
                
                log('shareApiResult', JSON.stringify(result, null, 2));
            } catch (error) {
                log('shareApiResult', `API æµ‹è¯•å¤±è´¥: ${error.message}`, true);
            }
        }

        async function simulateShare() {
            try {
                log('simulateResult', 'æ¨¡æ‹Ÿåˆ›å»ºåˆ†äº«...');
                
                if (typeof api === 'undefined') {
                    throw new Error('API å¯¹è±¡æœªå®šä¹‰');
                }
                
                if (typeof api.createShare !== 'function') {
                    throw new Error('api.createShare æ–¹æ³•ä¸å­˜åœ¨');
                }
                
                // æ¨¡æ‹Ÿåˆ†äº«æ•°æ®
                const shareData = {
                    shareName: 'æµ‹è¯•åˆ†äº«',
                    shareDescription: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ†äº«',
                    permission: 'READ_ONLY',
                    password: null,
                    expiresAt: null,
                    maxDownloads: null
                };
                
                const response = await api.createShare('test-file-id', shareData);
                log('simulateResult', `åˆ›å»ºåˆ†äº«ç»“æœ:\n${JSON.stringify(response, null, 2)}`);
                
            } catch (error) {
                log('simulateResult', `æ¨¡æ‹Ÿåˆ›å»ºåˆ†äº«å¤±è´¥: ${error.message}`, true);
            }
        }

        async function simulateGetShares() {
            try {
                log('simulateResult', 'æ¨¡æ‹Ÿè·å–åˆ†äº«åˆ—è¡¨...');
                
                if (typeof api === 'undefined') {
                    throw new Error('API å¯¹è±¡æœªå®šä¹‰');
                }
                
                // å°è¯•ä¸åŒçš„æ–¹æ³•
                let response;
                if (typeof api.getUserShares === 'function') {
                    response = await api.getUserShares();
                    log('simulateResult', `ä½¿ç”¨ getUserShares æ–¹æ³•:\n${JSON.stringify(response, null, 2)}`);
                } else if (typeof api.get === 'function') {
                    response = await api.get('/shares');
                    log('simulateResult', `ä½¿ç”¨ get('/shares') æ–¹æ³•:\n${JSON.stringify(response, null, 2)}`);
                } else {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„è·å–åˆ†äº«åˆ—è¡¨æ–¹æ³•');
                }
                
            } catch (error) {
                log('simulateResult', `æ¨¡æ‹Ÿè·å–åˆ†äº«åˆ—è¡¨å¤±è´¥: ${error.message}`, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkEnvironment();
                checkApiObject();
                checkShareManager();
            }, 100);
        });
    </script>
</body>
</html>
